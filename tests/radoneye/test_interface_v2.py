from typing import Any
from unittest.mock import MagicMock, call

import pytest
from bleak import BleakClient
from inline_snapshot import snapshot
from radoneye.interface_v2 import (
    CHAR_UUID_COMMAND,
    CHAR_UUID_HISTORY,
    CHAR_UUID_STATUS,
    COMMAND_BEEP,
    COMMAND_HISTORY,
    COMMAND_STATUS,
    merge_history,
    parse_history_page,
    parse_status,
    retrieve_history_v2,
    retrieve_status_v2,
    trigger_beep_v2,
)

# triggered by command 0x40
msg_40 = "4042323230313033525532303338330652443230304e56322e302e3200014a00060a00080000000300010079300000e01108001c00020000003822005c8f423fa4709d3f"

# triggered by command 0x41
# pages are in right order, from first to last
msg_41 = [
    "412401fa000005001000020007000a000d000000000005000a00070005000500070009000900050007000900030005001000090003000d0007000d0003000900050003000300090011000e000e000d0011001000190011000e000d000e0010000a000d000700090009001000140010001000050000000700090005000700020009000700090010000900030000000d000a0007000a000a00090007000a00000011000900100010000d00100003000e00070009000a000d0009000a000d000200090014000a000a000500050003000a000a000d0005000a0005000a000a000d00090005000500020007000700070007000700000007000300090003000500050002000300000002000300020005000700000002000000050002000500020002000300000003000200020005000d000d00000000000e000d00070002000300070002000d000300090014000e00070007000a00030009000300050003000200000003000700050005000200020009000200020000000a000a0003000a000a0005000a00100007000d000a000d0009000e0010001100150007000a000700090010000d0005000e000a00140010000d0014000a000d0010000d000d000e001400190015000a0011000d0011000d000500090019000e00110009000a000e000d0011001000140010001000090011000e0010000e0014000e000500",
    "412402fa0d0007001100090005000700090009000e000a000300070003000d000a000a000a000e000a0003000a00030011001000110011000e000d00070007000e000500070005000000070003000000090007000a00070009000a000a0009000900090002000500050009000300030007000a0009000a000a00020009000900100010000a0009000a00100011000d0005000300170010000900100014000e000a000a00150005000e000d000a001900110009001100140009000a0011000d000d000a00170014000e00110003000d000a000e001000090009000e00090002000e001100140010000a00110010000a0011000a0005000300070007000e000000070009001000110011000300100009001000140009000a00090009000a000d001100100009000a0007000e000d0005000700110017000e001400090010000500140011000d00090011000d0007000d0017000e000d00190009000900090005000a000900090005000900030000000300030003000a00070000000a00030003000a0000000e000300070003000a00030002000300070002000200000000000200030005000000050007000900030000000200030005000a00070000000500070000000500030003000000000009000300030009000300070005000000000007000a00020000000200070009000a00050002000a0003000200",
    "412403fa000005000300050003000300030005000300020002000a000000020002000a0005000a000a0014001500090005000a00070003000d00070003000d000d0009000e0005000d001100050005000d000d000d000a00030007000900090005000e000e0003000a0009000a0007000900000007000a0009000d00090010000a001000030009000a00070003000e0005000d00110007000d00050000000500030009000d0005000200050005000500090007000500050003000a000a00050005000d0003000d000900030003000700050002000d0003001000070007000900000007000200000009000d0009000a000900070007000a0005000900050005000a0009000e0005000a001000030005000a000a00090002000a000e0003000d000700030003000900070003000d0002000e0007000e0003000200000003000300000005000200090007000000050009000a000300000003000500070005000500070002000e00090009000a000a000d000d000d000e00070003000300030000000300070002000000020003000000030009000d0007000000070009000300090002000300000005000700030002000200070007000d00050009000300070002000d0007000200070003000900070009001000090007000a000a000a000e0009000e0015000900020005000d00070017000e000e0005000700",
    "412404fa0e000e0007000700050002000a0007000a000500000009000700030007000e00070005000200000007000200000000000200070005000700050003000200070007000000070009000a0005000e00070009000a0011000a000e0010001000070000001000050007000700050009000900090003000d000d000e0005000d0007000a0007000a000900050000000a000700070005000a000900000002000500000003000a0005000300000002000a00090007001100090003000a000a000a00050003000d00050005000000030003000d0007000700070009000700050000000200020000000700050002000500050002000a000e00090007000700000005000500020005000700090015000e000e00030002000d0009000900050003000300050005000700050000000900050007000900020005000200000003000300020002000300000007000d000a000a00090011000e0002000900030007000a000d000a00090010000a0010000e000500070009000500030003000700070003000300020002000000030000000000000005000a0003000500030005000900050005000d00110009000d0005000300090007000500050009000200030002000d0005000200030007000300030014000a000300140010000a0010000d000d00090007000a000700090003000a0010000d000500020007000200",
    "412405fa070002000a000300030005000a00070007000300070002000500020007000e0009000a00020005001000070009000a000a0005000d0005000a0005000900090007000300030007000900110009000900070005000700000009000d0009000a00110009000d000000000005000d0007000d0007000900090009000900020000000200070000000e0000000200000003000900020005000900000000000500030009000700070005000200020000000200090002000200000000000000020000000500000005000300030005000e00070007000200050003000700050005000900090007000a0003000500030014000a000d000500090009000200030003000300000003000200030007000e000d000900090010000a000500030007000a000d000d00090003000d000a00070003000a00030002000700000009000500050002000a000e00090002000a0005000e000a0010001900110000000900030005000a0003000d000d0009000d00050009000a000a000a0000000200070005000500050005000900090009000e000e000d00090010000500000009000500070003000000050000000700050003000700020003000a0011000a000d000e0009000d000700090007000e0005000e000e00050009001000110005000a0009000e000200030015000d00100009000a0003000d00070005000500",
    "412406fa07000000070007000a00030005000d0003000000020000000500000002000200000003000200050000000900020002000000000000000a0009000300030005000000070005000200030005000d00050000000d0007000a000500050005000500030005000a000e000a00050002000a000d000300100009000900190007000e0005000700050009000a0010000e000a000d00100009000e001000050007000000070009000d000a000a001000050005000500030005000900110009000500050005001400070009000e000e00110009000a000e00170009000e000a000d00050003000d000a0007000a0009000d00110010000a00110010000500090003000d00070007000e001500070011000a000000100009000300090005000900070003000a000500090009000d000d000900070005000e000500050002000300050009000a0003000300070002000000110005000300070005000a0002000a0007000300050007000300050000000300030002000a00000003000500090002000d000300030000001100000003000e00050005000a0007000300050003001400090007000d00050009000a000900020002000200140009000a00050007000a0011000e000d00000009000a000a0005000700050010000a000900030003000300070003000a000300090009000300070010000e0005000000",
    "412407fa020003000500000000000900090009000a0009000a00020009000a000700070005001000100010000d000500020003000d000000000003000500050009000d000d0005000900030000000500050002000200050007000e00090007000900030005000e000a000a0000000200070007000700030009000d00030005000500020003000d0007000d000d000500020003000900090003000900050007000200070009000e00050009000200000005000200030005000a0003000500090007000700050002000500070005000300030002000000030000000300030002000500000003000700030007000a000e000e00020011000d0005000200030005000300030003000a000d0009000e00070003000e000700020003000700090005000a0009000300050005000700070007000900020003000d00050007000500030002000500070007000e000e0009000e00070003000200020002000d00050003001000020007000d000a0000000900030005000a00070002000a0007000300000003000700050005000900000007000500030000000900030002000e000300070007000a0007000700000011000a00110007000a000d0005000d000e0003000e000500090007000d00070002000d000a000300050005000a000200100009000e0003000700030009000000030009000000070002000a000200",
    "412408fa070003000d00050007001700030003000300030019000d00140000000a000500070003000d00090005000d00070002000900070003000200070009000e000a000500030010000e0007000a000a0009000d00070007000d00090002000000030009000300020007000200030003000200030007000d00020000000d00000003000000030007000200020005000900020007000200070002000a00020009000300070005000700000005000500070002000300070005000300090005000a0002000700030003000200000009000200050000000e000500030003000a000d000900030005000200030007000500030000000d0003000200000000000000030007000200000005000200050003000700000000000500070000000300000003000a00050007000300050002000200030007000700100005000a000500070003000200050003000200050009000a0007000a000300070002000300000002000200030007000d000d000a00000010000a000a00070009000d0005000300110007000e00030002000900070007000a0000000a0017000d000a0009000500090009000e000a001000090009000d000a000e00140014000d000e0014000d000500020002000a0011000d000d0009000d0009001100050011000d000700140009000a000d0007000200100005001500070009000d000d000d00",
    "412409fa00000a000900070007000500090003000a00090003000d00070007000500070009000500070003000200090009000000030002000300000000000200020009000700020000000700020003000a00000000000000000003000a0003000200030003000000030000000500070003000a000300050009000700030009000000030000000d0003000500000003000e000d00050011000a0010000d00090009000e0003000e0009000a00000007000d0007000200090003000a00030003000300070002000300090009000500020003000500000005000300030002000d00030007000000000003000000070009000a000900070003000300050007000500030002000a000900020005000500030000000a000a00050002000300000005000300050009000700000003000200030005000500000007000d0005000000020005000500050005000a00050003000500070009000a00030009000e00070003000a0005000a000e000a0009000300020003000d000d001000070010000500090005000200090002000e000500050005000700030005000000050007000a000900090000000a0003000700020009000d000d001700050007000900020007000e0005000500070002000a0010000900110007000000070007000a0003000d00070009000a000d00020009000300000003000200000005000300",
    "41240afa0900020005000500070002000e0005000300020003000500030007000300050005000d000d000700000003000700090005000500070007000900070002000d0003000300020003000d00050009001000030003000700070007000a00070007000900000010000500090007000a000300050002000000030000000d00020003000300020009000e00020000000200030009000000020005000500000007000d000500000003000700030009000a0002000300070009000a0010000300020002000900070005000300020007000300070003000300050000000e0005000d00000009000000070007000500000003000500030009000700050009000d000a00070005000200050009000d0007000300000005000500020002000000030003000900050003000200030000000300050009000200000002000300050000000500050005000500020009000e000900090007000e000d00020002000000070007000d0005000200100007000a00070003000900070003000700030003000a00090003000300090005000700000007000500020009000a00000009000a0003000300030003000000020000000200000002000200030007000700090009000a000900030002000200030005000e0003000700020003000a00070005000d00030009000a000a00020003000300050002000500070007000200",
    "41240bfa02000300000000000700050002000000050009000700020000000300090007000300070002000000000003000200090009000300030009000300050009000300050007000500090005000300020002000300050002000a00030005000900070000000900000003000a000e00070009000a00090003000a001900090009000000050009000000000007000500070000000200030003000300090002000300090000000300030005000200000000000200000002000200030002000500020002000200090005000500000002000a00020005000200000002000e0003000200070002000200090003000d00050003000200070009000a00020000000a0002000d000d0010000d0009000200020009000300050000000900030005000900000000000300020003000200000005000900020002000500000000000200000003000500020003000500020007000d00090003000700070007000300050005000a000900050009000500020002000000000005000a00050005000200000002001000070005000500020002000a000a0000000300050003000000000003000300020002000900030007000500020002000000030009000500030003000000020003000200070009000a000d000a0003001000000000000d000200070009000d00090011000a00000002000a00050009000500050009000500",
    "41240cfa0300050003000a0000000300030002000000000000000700050005000300050009000a00070009000d00030005000700050009000a00070002000900030000000000020000000700020009000000020009000300000002000a0009000d000700050003000700050003000d00050003000000000002000000020003000200020007000500070003000500090003000700020003000000030002000300030002000300000002000000020003000200030000000300050000000700030003000300050009000500000005000300030003000000000007000e000700050003000700070007000500020005000200030002000500030007000200070002000300000000000200000003000900020002000300020000000000050005000200000002000000030002000500000003000700030002000000000002000200000007000700000007000700020005000700000003000700030007000000000002000d000700030003000900070003000500020005000300020009000000090003000300020003000300030002000000030000000e0009000d000d00020000000500000005000300030003000200090007000000000000000500020002000700070002000200020002000700030000000500020000000a0007001000030005000d00050007000700030007000300000005000200050005000000",
    "41240dfa000009000a00050000000a0003000300000005000a0007000d0003000500030009000700090000000500070005000700000003000500030002000900050007000700090009000a00030003000700090000000200020005000000030007000000050003000300030005000700140002000900020007000700070005000e0003000d000200030002000200050005000a0000000500030000000300030009000500070005000a0002000500070003000e000a00050007000300020000000200050003000000030007000500050003000e000500090009000d000d000200030003000d000900020007000a000700070005000300000003000700050003000900070007000500030005000000020000000500020005000900090002000500020002000200020009000500020002000e000000020002000000000002000700020002000700000000000200000002000a000500050005000d00090005000500070009000a0005001000020009000700000003000300050009000900030007000d000500090005000700030005000a000900100007000000050003000000000000000000000002000200070002000300020002000a0007000300030002000a0003000a0002000200020002000200020005000200000002000700030007000200090007000500050005000900090000000700100009000300",
    "41240efa0200050003000000020000000700030000000500030000000200020009000000030005000a0000000700070005000700050000000700020003000300020003000500090007000300000002000700070000000000030000000900090003000a000500050009000500000000000900070005000200030000000000000003000200020003000700020003000700050009000500070002000200000003000500000009000300050003000700000000000200020000000d0003000500050005000200090009000000070002000300090003000a00000009000700030002000000020002000500050007000200000000000a00050003000700030003000900000005000500000003000000050005000700020002000300020007000500030003000a0007000900070003000200050002000200020000000200000005000300000005000000070007000d0003000d000700050002000900050005000a000700070005000a000000030003000000000000000200100003000d001000070007000700020002000300020003000000090003000500020005000200020000000700070003000a0003000000050003000a00030005000000030003000000000002000000020003000200050002000a00030002000700030003000700020009000300070002000000030002000700000007000000020002000200",
    "41240ffa03000900030000000200090005000200050005000a0003000d00050007000500070007000000030002000500000005000200030003000700020009000300020009000700090009000900050007000000020002000700050005000a000500070005000000070003000500090003000d000d00070000000300030000000500030009000a00020005000700070002000200030003000700000002000700030005000a00020007000a000300070010000700030003000a00000009000d00030007000500020005000000000003000a0003000200110002000500090007000d00020005000e0009000a00150015000900050007000300020002000200050009000500030003000e000900050009000900020003000200090007000200030011000700090005000300030007000200090003000d000500050003000000090003000a000300000007000700000000000300020000000000000002000300020000000500070003000200030009000500000005000500090007000a00090005000200020005000000030002000500000003000500030003000a0005000a0005000700030003000700070005000700050007000a00070007000700050003000200050003000900070000000a0009000500070007000d0002000200050003000700030003000300050003000700020000000300020005000200",
    "412410fa09000200070002000a000500050002000a000700020009000300050000000500000003000300030009000e00090011000e000d000a0009000a000700070009000500050003000a0002000200000005000700050002000200030005000200090000000d000a000300020002000700020002000900020000000200020002000000070005000500000002000500020002000a000700070000000000090005000200030005000000050003000000000003000000030002000200000002000700020005000900000000000d000000140007000d0000000300020000000000030000000000030002000900050007000700030005000200020005000300020002000000030002000a0003000000020000000300000005000700070003000200070002000a000700050007000a00070003000200000003000200000000000700020000000300070002000900070003000e000200030002000700030000000e0002000e0005000000030000000200020000000200030002000200020003000000020003000700070003000900000003000700070003000200020003000300030000000700020000000000000000000000030007000a000a0000000300050002000000000002000500090000000200050000000a0005000a000d000a001100070005000a0003000a000500070007000d000a00100015000500",
    "412411fa09000200000003000000050000000000030005000300000003000000000003000500020003000a000d00020000000000020000000300000000000300020003000000020003000000000000000300020003000000030003000300030002000300050000000300020002000300020000000200020005000700050000000300090003000a00000000000000050000000200020002000e00050002000900050003000000020002000200070005000000020007000000090003000500020005000200030000000000070007000d00070009000a0007000000000003000200070002000500070002000a0005000500050000000500030000000300000005000300090005000300030005000500070005000500000007000300000000000a00050005000000000005000000000000000d000200030002000000020002000200070000000a0005000200090003000500030005000200020000000200020003000200020005000500090005000e0003000a00030000000200000002000500000007000e00020000000700000005000300070009000a00000005000700000007000900070007000d0003000d00070005000900070007000d00070000000300050002000000030005000700030002000700050002000700030003000000000009000e000a000500000000000000000003000000020002000700",
    "412412fa0300020002001000050007000d000d00030002000a0005000900050003000000090000000000030002000200000000000200000005000d00070005000300050005000500020009000000050002000900070003000700020003000300000003000200030000000300000007000000030000000200000002000200000000000500030005000500020000000300030003000d00020002000900020009000900020000000000000005000200090005000700020000000000000005000900030005000500030007000e000a00000002000500090002000e000a00090009000a00050009000000000002000000000002000200000002000200070003000a000500000009000a00030002000900090007000000020003000000030000000000070000000000070000000e000a000200020005000200030005000a00050002000700030000000500070002000700000009000300020002000300070002000d0005000500030005000300030014000300000007000300030002000200070009000900030000000200100007000500030000000a00050007000700090007000a000700000005000700000002000300000005000200020002000300000003000200020000000300030005000500030000000200070003000300020002000300000007000a00030009000a000d000a000e001c000d000d001000",
    "412413fa0a000d000d0009000300000000000000020007000000020007000a000500030003000a00030009000500020000000200020003000700070007001500090005000d0003000d000900050007000a000300050007000500090009000200090000000500050003000200020003000200030003000200020002000200050000000500030005000500030009000a00030000000a00070007000d000300020005000300050003000300030003000200020000000700070005000500020007000500050007000900050002000000000002000300000000000300070005000300000009001500020007000300000003000700020002000300000003000200030009000500050002000000050005000300000000000200020000000000000003000900020003000300070003000700000007000000000000000000030003000300000005000200090009000700030005000200000002000200020002000300000003000200020003000d0009000d000500050000000a00030002000d00090000000a000700000002000700020002000200070007000e000d0009000a000200000007000a00090009000900000000000300030002000300000000000000000000000500000009000d000900070005000e0009000000090002000500070007000d000700090003000000090002000200070000000a0000000700",
    "412414fa000007000700030005000900050009000900030007000500070003000e000000020007000300030000000500050002000a00070000000200000003000200030003000700050000001000030007000700030003000000070009000300000000000200000002000300090009000000050002000900030005000200050009000500030007000300020002000300000005000500070005000900020000000300070009000500070000000500050007000900070005000000020000000000030003000900020003000300050007000700090000000500030007000200030005000200020000000300050005000300000000000000000002000a0003000500050005000a0002000200020003000000070007000500070002000300050005000300030000000200000002000d0007000a000000050007000700070009000a00030007000e000900090002000500030009000a00030000001400020007000700030000000700050000000300030009000a000000070003000200070009000a00070007000700050009000d0009000a00000007000e00070000000200030005000900020000000300020007000000030000000200070007000700050009000d0009000000070009000d00030007000d0002000000000000000300000003000000020000000000000005000000030002000300030002000900",
    "412415fa0000070005000900050002000000070007001100090002000a000d000700020005000500030003000200000003000300020002000a00030007000500020000000500020007000200090000000e0014000a000e000a00100011000e0011000e000d00050009001100140002000e000900020000000000020000000500000007000200000003000500020003000a0000000500000002000300020003000000000000000200020000000900000003000900070009000500020003000700050003000200000003000d00100000000200020000000000000002000700000000000700020002000200020002000a000300050000000300090003000000050000000700000000000700030002000200020002000700050005000900050000000500070002000500030009000900020007000200030000000200020002000700030000000200030000000000020002000a00050000000500050002000700050007000700050000000a00000003000700050003000700070003000300030002000500050003000500090005000000030003000a000500000003000000020007000700050002000500070007000200050007000300030000000200090007000700030005000200090002000000020005001500020003000300070003000900050003000e000300030002000a000700050003000a0005000900",
    "412416fa0700050005000300030003000300050007000900020000000000000007000300000003000700030000000000050002000500140009000d000300030003000300070003000700000002000000030002000000020000000000000003000300000000000000000003000000020007000500020005000a00050007000500070007000d000700020009000300020000000500020000000300000002000300030002000d000a0009000a0007000200020009000a00020003000500070000000000000002000000020002000300000003000200090003000200000005000300050002000200070007000200000000000500020000000200000002000000050003000700000002000500020000000200030005000200030007000a000700020005000200000002000000050000000900030003000200000007000a00070009000a000d000200050003000e000a00050002000300030009000500030007000a000300030007000300070005000d00090005000d0009000d00050007000900070007000500000005000500000002000300070000000300090015000d0011000900070011000a0007000900090000000000030000000300020003000200050007000300000005000200000009000900000009000300020002000000030000000000000003000200020000000000020000000300000002000700",
    "412417fa050003000300020003000a000300050002000e00020000000200020005000000020003000500090002000200050010000a0005000d0000000000100007000700020009000300030003000200020002000300000002000700020009000a001b00050011000900050003000e0009000300090002000000000003000500000000000900090000000000050005000000030003000a000500020000000700030003000000000007000500030003000200000000000300020007000200090005000700090007000a00050003000a00070003000000090000000000050005000200020003000300000000000700050003000a0007000500050002000000050005000300020000000000020005000000020002000300020005000000090000000300100005000200020005000a0002000200070005000e00030005000500050005000300030000000000050009000500000000000d000200000009000a00050005000500090003000200070002000000020003000300000005000200000000000200030011000a00090000000700050009000300020009000700090002000000050000000700020002000000000002000a000200030003000d000900070009000500030003000d000a00050007000300030009000a00030007000a0003000300020000000d00050005000000000003000000090005000000",
    "412418fa070000000300020003000000020000000500020002000700030002000a00020009000500000007000700020007000500020002000700020002000000070003000200020005000a0005000a000700070009000d000700090003000e0003000000000000000000000003000200000002000700020007000200020003000a00020005000200090003000000070002000000020009000500030000000000000000000700030007000d001100100014000700070007000a00020005000700020000000000050000000500020007000200000003000200020005000a00070003000900030007001000030000000700000000000200050003000300020002000000000005000000030002000000090003000200000007001000050003000200090009000000030002000300030005000000020000000200030011000200030009000300070003000300090007000d0000000500090002000900090000000300000000000900020009000a00030009000e00070007000500070002000300090009000500050007000a00020003000200000005000200000000000e0002000a000300070007000a000000030009000e000300000002000500050003000500050002000200050009000000020005000a000000090005000300020011000d000a00050005000200000005000000000000000200030000000200",
    "412419fa03000700030010000d00070009000a000900050000000a000200070007000500020000000300000005000a000700070003000900090011000500050005000900030003000a0005000500090005000900020002000900000000000000050005000300000005000a0002000d000d00000007000300050000000300070005000a000300000007000300000002000200000000000000070000000300030003000500000000000200000000000700000009000300030002000200000003000000030000000700020000000200020003000a0007000700050002000200030009000300090000000500000000000300050002000300030003000500030010000500070002000500000009000e000e0010000500020005000500020009000500090009000a000a000a000500020005000000000003000700000005000500090005000d0009000d00090007000a000e000000020003001000030007000700070002000500030007000a000700100009000e00020003000a0005000e00090014000900090010000a001000150007001100070009000a0002000a001100050005000a00110007000300050015000a000d0007000300070003000d0005000a000a0009001400100007000a000e0009000d0002000a000d0003000a000e0007000500050007000e000a00050003000d000a000a0003000a000500",
    "41241afa09000a0010000700070007000a0002000e0003000700050005000d0003000200030003000d00090003000200050007000300020005000e000500030000000900000009000900070005000500070003000a000d00050009000a00050003000700030002000000000002000a00020003000200000007000000000007000000000003000200090002000200070009000a0003000200000003000300020000000000020007000a0009000200070007000700090007000a00020002000300070005000500050000000e000a0009001100090007000300030005000a0007000d0003000700000007000500070000000500030000000700020003000700030003000700020007000700050009000a00050000000900070007000500050007000a00070005000d00090005000900030002000200000005000300070007000a00020000000300050003000000050005000200070002000000030000000300050000000000000003000500030000000000030000000500030002000500000005000500050009000500030003000000020000000200050000000000000009000200090002000300020002000000070009000000050005000900020002000d0007000a000a000e000900090005000200050000000700000003000500090007000000030003000300000002000300030002000000000007000500",
    "41241bfa0000030007000900030000000500070003000a00030003000000070005000900050007000700070000000000030000000300020002000300020005000300050002000d000e001000020007000500050005000900090009000700020002000500000000000000020003000900050000000e0007000d000d00000000000a000500020003000500050003000000050005000a0002000500050005000d000500090009000a0007000300070009000a000a000a00090005000700000005000300000003000300000003000000030002000900070007000900050003000700030005000e00050010000300030002000000050003000000000002000200050009000a0007000a00090005000000000009000700090005000300020000000000020000000200050003000a00030011000d000500030007000700020005000d000700070003000000070002000200030003000200020002000a00000002000200000009000500070005000500090007000a0009000700020009000a0009000000030005000300050007000000050000000900070007000d0009000a000e000a000900050003000e000900110007000500070002000700000003000700090007000500030007000900050005000e00070003000a000e00090000000000070000000700000002000300020007000e0009000e0005000d001100",
    "41241cfa09001100090003000900090007000d0005000000020003000d000200070000000000050005000200070005000e000700090003000d00090009000a000e0011001400000000000a000200050015001000140014000d001100110010000d001500140009000e00100017000d000e000a000d000e00090009000900090005000900050014000900070009000a0009000a0007000e0007000700050005000200030005000000020000000200090002000700070003000700090003000700020009000500030000000a000200070009000d000700050002000000000005000200030009000200050009000d000a000000070003000700020000000200070005000300020002000700050005000300000005000200070002000e0014000a0005001100070009000700070010000e000e000d00070002000e000000090005000d000a00090014000e000d0017001000090014000a00030010000a0010000a000a0011000500090003000700030000000300000007000300090019000d000d0014000d0007000d000700140007000000070009000000000000000500000000000700020005000500030007000a000500020005000d000300090009000700000003000500050003000200030002000300020007000000030007000900050003000000020002000900050005000900090014000e0003000700",
    "41241dfa02000200050003000000050009000d00070010000900050009000200030007000d0015002200190010000a000d000d000d000a000700140005000700050002000a00090010000d000a00030003000500090005000900090011000300100007000a000200030003000000070003000a0015000a00090009000e000a0011000300140011000a00070009000e0010000e0015000900070009000a00090007000a0005000e000e001000070014000a000d000d000d001100110011000700170014000a000e0005000500090003000700020005000a00050002000000030007000500020003000000030009000000070002000700020005000a0007000300000000000000090000000500000005000200000005000000030003000200000000000300000007000300030003000300050002000200090000000200030005000500090000000300050009000900100009000500070003000700030003000500030002000300030009000d000500050003000a0005000a000e00090009000d0009000900030009000500000003000d000500050005000a000d000e0009000a000a000e000500070007000a00100005000d0009000300050002001100140007000d000a001500070010000a000a0017000e000e000a0017000a0009000900050009000d00110007000e0002000d0005000d00150007000d00",
    "41241efa10000a000a001b00170011000d0011001100140005000a00090002000200140010000a000a0009000e0003000d00090009000d001000070007000d000d000e0005000a000d000700090009000d0009000a000e0007000a00090003000900090010000d00110009000d000d000900090002000d0017000a000e000e000d00050009000a000d000e000a00050009000e0003000500070002000d00070017000500050007000a00020009000300030003000d0000000200090007000a000300090010000a00140014000e0007000d000d00150007000d000d0007000200090007000500070007000e001900090009000a000a0010000e000d000e00030009000700140015000a00070007000a00030009000a00030003000d0010001100050005000a0019000d0009000d001000090011000a0014000d001000100015001400150007001700100019000e0015000500100014001100190011000e00090007000a000e0017000e0007000d0009000a0011000e0011001100030009000500110014000d00170014000a000e000d0009000d00090017000e000a0011000a000a0005001000140005000d0009000e0003000a000d00190014000d0005000500070003000900070009001500100014000a000a0007000900030002000300020007000a000700090005000500020005000000000007000300",
    "41241ffa07000d000e0007000a000500070002000200000000000700050005000d000d000e000d00070007000000050007000d00090007000e0009000a000a000d000500090009000a000000030003000300090005000300030005000000050007000a000a00050007001000090009000700090017001500050005000d000d0003000e000e000d000a0014000500030007000700100010000d0003000a0009000900050009000e000d000e0007000a000500070007000700090007000700050005000e000e000900110019000a0003000500070002000900050007000d0009000d0011000d000d000e000300000003000a0007000a000e0005000a000e0005001400090011000d000a00030005000d000e00050011000e0009000a0009000a0007000500050017000e000d00090003000a00020009000700020007000e0017000e0015001900200009000300000003000900050005000a0002000e00170005000500090007000000070005000a0007000d000700070007000a000a00070009000200110014000d000900070005000d0011000900030009000e00090009000d00150011000a0007000e0009000e000500070002000a000d0015000a00050007000a00030009000700070003000500030009000900070007000a00000003000200050000000700050002000a00070002000500090002000900",
    "412420fa0a000a0000000700070009000d0005000900030002001100030003001000150011000200050007000d000a0003000d000a000d0000000d000a00100011000a000e0003000a000d0009000a000200030009000700050005000900000002000200070000000a000a0007000200050002000500030000000500020005000000090005000300070003000200000011000700000000000300020009000e000a000a00050003000200030007000200000002000300050002000700020010000500090007000500070009000e00110009000500050009000500020005000a0007000000050002000a0009000e00070007000e0010000300070014000a00110019000a0011000a0005000d00100007001500150007000300050003000700030009000500150011000d000a00090014000d00070005000200030005000000090007000a00090010000e000d0005000d000a0003000d000700050010000a001000100010000a000000100007000a00070015001f00110014001000050002000a000a00020014000e00030007000a000a0005000d000e000d00110009000e001400110015000d0007000d0009000e000d000a00100015000e0014000d0002000200110007000a000000000009000900070007000000090000000700020002000500000003000300020007001000030009000300020003000500",
    "412421fa0d0003000a000300000002000200050005000500000002000300000003000000000005000500030002000a0000000700020005000a00090007000200070005000000020003000300070010000500090005000a0005000200030007000900000007000e00000011000700110007000500030002000900090003000d000d000700110003000e0002000d000500000010000e0005000d0007001500070009000300020003000700070014000e0009000a00030003000a000d000a000d000500000005000a000300090007000d0007000d000500050003000700070009000d000900070007000700090007000a00000009000700050010000e0007001000030009000700000002000a00070002000e000a000a000d000d000200020007000900020009000700050005000900090002000900070003000500020005000a0005000e00070005000e000d00090007000300090009000d0005000d00110019000e0011000e000e000e0007001400070007000e00140009000d000e000e0002000200000003000a000700050007000a0009000e00070011000a0007000e000900090005000900090007000a000e00050005000000000009000a001000090010000a000700020002000500090000000a00090007000e0011000700000003000300090003000700050009000200000005000500070003000300",
    "412422fa0700050005000700090003000a0005000d000d00020009000d00070009000a00050009000700020003000e00070011000d0009000d000e0019000a001000170019001900100007000e0015000d0009000d00170014001b001f00110015000e000a000d000e000e001700110015001b001b00190014001100100014001500170011001900150015000d0014000d000d000d00230019000d00090015001b001900140017000d001500110005000d000a00050007000e000d000e001000100009000900090010000e00000011000e0005000e000500030010000900050003000d000d00170015000000030003000500000005000700030005000d0003000e000a00150007000e00030007000e0009000700050005001400140014000d000300050009000500050007000a000d00070007000900090005000a000a00140010000d000d0007000500110011000e000d00050003000500050009000900050000000a000e0002000a00090007000a000a0009000e001000070005000a000e000500070000000200090009000a000a000d000a000700030007000d000300050007000a000900070011001400030005000300050011000a000900100007000500100017000e000a00100019000e00140010001400090015000a0017000d00090009000a0009000e001f000d001500170011000d0017001000",
    "412423fa0e0007000d0014000d00070010000900100009000d000d0019000d000a000e0011001400170014000d000a001900170017000900170007000e000d001400110009000d000e000e000900050003000700030003000a000900090009000200070000001400030003000700050005000e0009000a000900030003000900070007000d00030002000a0005000d00090015000a00090009000d000900110009000200100005000900030005000d00070007000000030002000500090005000a0003000e00050003000a0000000d000e00020007000e0007000a00090003000d000d0015000200100011000a0010000d0005000a0005000a000d000d00030009001400100007000300090007000000050009000500000009000a00150019000a000a00090009000a0007000900070009001900090003000a00100003000d00070005000a0009000e0009000a000700090009000e000a000d00020000000d000900150017000e000e0010001000090007000a0007000e0005000a000e000e000d00070003000a000d001000020005001c0010000d0003000a0002000700020015000700070015000e00050010000d00090000000a000a000e00100009000d0011001100050005000500070007000a00090009000e00090005000200090002000000070005000300050003000300000005000a000d000d00",
    "4124240a02000a0009000200000005000e00030009000700",
]


@pytest.fixture
def bleak_client():
    notify_callback: Any = None

    def start_notify_side_effect(char: Any, callback: Any):
        nonlocal notify_callback
        notify_callback = callback

    def stop_notify_side_effect(char: Any):
        nonlocal notify_callback
        notify_callback = None

    def write_gatt_char_side_effect(char: Any, data: bytearray):
        if notify_callback is not None:
            if data[0] == COMMAND_STATUS:
                notify_callback(char, bytearray.fromhex(msg_40))
            elif data[0] == COMMAND_HISTORY:
                for msg in msg_41:
                    notify_callback(char, bytearray.fromhex(msg))

    client = MagicMock(BleakClient)

    client.start_notify.side_effect = start_notify_side_effect
    client.write_gatt_char.side_effect = write_gatt_char_side_effect
    client.stop_notify.side_effect = stop_notify_side_effect

    return client


def test_parse_status():
    result = parse_status(bytearray.fromhex(msg_40))
    assert result == snapshot(
        {
            "serial": "RU22201030383",
            "model": "RD200N",
            "version": "V2.0.2",
            "latest_bq_m3": 10,
            "latest_pci_l": 0.27,
            "day_avg_bq_m3": 8,
            "day_avg_pci_l": 0.22,
            "month_avg_bq_m3": 0,
            "month_avg_pci_l": 0.0,
            "peak_bq_m3": 28,
            "peak_pci_l": 0.76,
            "counts_current": 3,
            "counts_previous": 1,
            "counts_str": "3/1",
            "uptime_minutes": 12409,
            "uptime_str": "8d14h49m",
        }
    )


def test_parse_history_page():
    result = parse_history_page(bytearray.fromhex(msg_41[0]))
    assert result["page_count"] == snapshot(36)
    assert result["page_no"] == snapshot(1)
    assert result["value_count"] == snapshot(250)
    assert len(result["values_bq_m3"]) == result["value_count"]
    assert len(result["values_pci_l"]) == result["value_count"]
    # just 10 items is enough to check
    assert result["values_pci_l"][:10] == snapshot(
        [0.0, 0.14, 0.43, 0.05, 0.19, 0.27, 0.35, 0.0, 0.0, 0.14]
    )
    assert result["values_bq_m3"][:10] == snapshot((0, 5, 16, 2, 7, 10, 13, 0, 0, 5))


def test_merge_history():
    pages = [parse_history_page(bytearray.fromhex(message)) for message in msg_41]
    expected_values_bq_m3 = [value for page in pages for value in page["values_bq_m3"]]
    expected_values_pci_l = [value for page in pages for value in page["values_pci_l"]]
    history = merge_history(pages)
    assert history["values_bq_m3"] == expected_values_bq_m3
    assert history["values_pci_l"] == expected_values_pci_l


@pytest.mark.asyncio
async def test_retrieve_status(bleak_client: Any):
    result = await retrieve_status_v2(bleak_client, timeout=1)

    assert bleak_client.start_notify.call_args[0][0] == CHAR_UUID_STATUS
    assert bleak_client.stop_notify.call_args[0][0] == CHAR_UUID_STATUS

    assert bleak_client.write_gatt_char.mock_calls == [
        call(CHAR_UUID_COMMAND, bytearray([COMMAND_STATUS])),
    ]

    assert result == parse_status(bytearray.fromhex(msg_40))


@pytest.mark.asyncio
async def test_retrieve_history(bleak_client: Any):
    result = await retrieve_history_v2(bleak_client, timeout=1)

    assert bleak_client.start_notify.call_args[0][0] == CHAR_UUID_HISTORY
    assert bleak_client.stop_notify.call_args[0][0] == CHAR_UUID_HISTORY

    assert bleak_client.write_gatt_char.mock_calls == [
        call(CHAR_UUID_COMMAND, bytearray([COMMAND_HISTORY])),
    ]

    pages = [parse_history_page(bytearray.fromhex(message)) for message in msg_41]
    history = merge_history(pages)

    assert result == history


@pytest.mark.asyncio
async def test_trigger_beep(bleak_client: Any):
    await trigger_beep_v2(bleak_client)

    assert bleak_client.write_gatt_char.mock_calls == [
        call(CHAR_UUID_COMMAND, bytearray([COMMAND_BEEP]))
    ]
